<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dVPN Web Connect</title>
    <style>
        /* --- General Setup & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap');

        :root {
            --bg-color: #0d0f1a;
            --card-bg: rgba(20, 25, 40, 0.7);
            --primary-glow: #00aaff;
            --secondary-glow: #aa00ff;
            --text-color: #e0e6f0;
            --text-secondary: #a0a8b8;
            --accent-color: #00d4ff;
            --success-color: #00ffaa;
            --error-color: #ff4d4d;
            --font-primary: 'Orbitron', sans-serif;
            --font-secondary: 'Roboto', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-secondary);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* --- Animated Background --- */
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 25%, var(--primary-glow), transparent 25%),
                radial-gradient(circle at 80% 75%, var(--secondary-glow), transparent 25%);
            filter: blur(100px);
            opacity: 0.4;
            animation: move-glow 20s infinite alternate;
            z-index: -1;
        }

        @keyframes move-glow {
            from { transform: translate(-10%, -10%) scale(1); }
            to { transform: translate(10%, 10%) scale(1.2); }
        }

        /* --- Main App Container --- */
        #app-container {
            width: 100%;
            max-width: 420px;
            padding: 20px;
            z-index: 1;
        }

        .main-card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 30px;
            transition: all 0.3s ease;
        }

        /* --- Card Header --- */
        .card-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .card-header h1 {
            font-family: var(--font-primary);
            font-size: 2rem;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--accent-color), 0 0 20px var(--accent-color);
        }

        /* --- Card Body & Dynamic Content --- */
        .card-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #initial-view {
            text-align: center;
        }
        
        #initial-view .status-icon {
            font-size: 5rem;
            color: var(--error-color);
            text-shadow: 0 0 15px var(--error-color);
            margin-bottom: 10px;
        }
        
        #initial-view .status-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        #credentials-view {
            display: none; /* Initially hidden */
            flex-direction: column;
            gap: 15px;
        }
        
        .location-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .location-display .icon { font-size: 1.2rem; color: var(--accent-color); }
        .location-display span { font-weight: 700; }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .detail-item {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .detail-item .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            display: block;
        }

        .detail-item .value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--success-color);
            word-break: break-all;
        }

        .vmess-link-container {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 0.8rem;
            word-break: break-all;
            cursor: pointer;
            border: 1px solid transparent;
            transition: border-color 0.2s;
            position: relative;
        }
        
        .vmess-link-container:hover {
            border-color: var(--accent-color);
        }
        
        .vmess-link-container::after {
            content: 'COPY';
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            font-size: 0.7rem;
            font-weight: bold;
            background: var(--accent-color);
            color: var(--bg-color);
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .vmess-link-container:hover::after {
            opacity: 1;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        /* --- Buttons --- */
        .btn {
            font-family: var(--font-primary);
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 12px;
            border: 1px solid var(--accent-color);
            background: transparent;
            color: var(--accent-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background: var(--accent-color);
            color: var(--bg-color);
            box-shadow: 0 0 20px var(--accent-color);
        }
        
        .btn.btn-secondary {
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }
        
        .btn.btn-secondary:hover {
            background: var(--text-secondary);
            color: var(--bg-color);
            box-shadow: 0 0 20px var(--text-secondary);
        }

        /* --- Modals --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s linear;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-family: var(--font-primary);
            font-size: 1.2rem;
        }
        
        .modal-header .btn-back,
        .modal-header .btn-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-header .btn-back:hover,
        .modal-header .btn-close:hover {
            color: var(--accent-color);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* Custom Scrollbar */
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: transparent; }
        .modal-body::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 6px; }

        .location-list li {
            list-style: none;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-list li:hover {
            background-color: rgba(0, 212, 255, 0.1);
        }

        .location-list .servers-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: rgba(0,0,0,0.2);
            padding: 4px 8px;
            border-radius: 10px;
        }

        #qr-code-container {
            padding: 30px;
            background: white;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Loader & Toast --- */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-color);
            color: var(--bg-color);
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 700;
            box-shadow: 0 0 20px var(--success-color);
            transition: bottom 0.5s ease-in-out;
            z-index: 2000;
        }
        
        .toast.show {
            bottom: 30px;
        }
        
        .error-message {
            background: rgba(255, 77, 77, 0.1);
            color: var(--error-color);
            border: 1px solid var(--error-color);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 15px;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="main-card">
            <div class="card-header">
                <h1>dVPN Connect</h1>
            </div>
            <div class="card-body">
                <div id="initial-view">
                     <div class="status-icon">⏻</div>
                     <div class="status-text">NOT CONNECTED</div>
                </div>

                <div id="credentials-view">
                    <div class="location-display">
                        <span class="icon">🌍</span>
                        <span id="selected-location"></span>
                    </div>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="label">IP Address</span>
                            <span class="value" id="ip-value"></span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Port</span>
                            <span class="value" id="port-value"></span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Protocol</span>
                            <span class="value" id="protocol-value"></span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Status</span>
                            <span class="value">Ready</span>
                        </div>
                    </div>
                    <div id="vmess-link-output" class="vmess-link-container"></div>
                    <div class="action-buttons">
                         <button id="show-qr-btn" class="btn btn-secondary">Show QR</button>
                         <button id="reset-btn" class="btn btn-secondary">Reset</button>
                    </div>
                </div>
                 
                <button id="select-location-btn" class="btn">Select Location</button>

                <div id="error-box" class="error-message"></div>
            </div>
        </div>
    </div>

    <div id="location-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button id="modal-back-btn" class="btn-back" style="display: none;">&lt;</button>
                <h2 id="modal-title">Select Country</h2>
                <button id="modal-close-btn" class="btn-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <div id="modal-loader" class="loader"></div>
                <ul id="location-list" class="location-list"></ul>
            </div>
        </div>
    </div>
    
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Scan QR Code</h2>
                <button id="qr-close-btn" class="btn-close">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; justify-content: center; align-items: center;">
                <div id="qr-code-container"></div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <script type="text/javascript">
    /* qrcode.js v1.0.0 - http://davidshimjs.github.io/qrcodejs/ - Licensed under the MIT license */
    var QRCode;!function(){function r(r){this.mode=o.MODE_8BIT_BYTE,this.data=r,this.parsedData=[];for(var t=0,e=this.data.length;t<e;t++){var i=this.data.charCodeAt(t);i>65535?(this.parsedData.push(240|i>>18&7),this.parsedData.push(128|i>>12&63),this.parsedData.push(128|i>>6&63),this.parsedData.push(128|63&i)):i>2047?(this.parsedData.push(224|i>>12&15),this.parsedData.push(128|i>>6&63),this.parsedData.push(128|63&i)):i>127?(this.parsedData.push(192|i>>6&31),this.parsedData.push(128|63&i)):this.parsedData.push(i)}this.parsedData.length>0&&this.parsedData.length<this.data.length&&(this.data=this.parsedData),this.parsedData=[],this.getByte=function(r,t){for(var e=[],i=0;i<8;i++){var o=t.get(r*t.width+i);e.push(o)}for(var n=0,a=0;a<8;a++)n+=e[a]<<7-a;return n},this.getLength=function(){return this.data.length},this.getBits=function(r){return(255&this.data[Math.floor(r/8)])>>7-r%8&1},this.write=function(r){for(var t=0,e=this.data.length;t<e;t++)for(var i=0;i<8;i++)r.set(t*r.width+i,this.getBits(8*t+i))}}function t(r,t){this.typeNumber=r,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[],this. PAD0=236,this.PAD1=17}function e(r,t){if(void 0==r.length)throw new Error(r.length+"/"+t);for(var e=0;e<r.length&&0==r[e];)e++;this.num=new Array(r.length-e+t);for(var i=0;i<r.length-e;i++)this.num[i]=r[i+e]}function i(r,t){this.rsBlock=r,this.dataCount=t,this.totalCount=r.totalCount+t,this.dataCache=new Array(this.totalCount)}function o(r,t){"string"==typeof r&&(t=r,r=void 0),"object"==typeof(t=t||{}).colorDark&&(t.colorDark=t.colorDark.hex),t.colorDark=t.colorDark||"#000000",t.colorLight=t.colorLight||"#ffffff",t.correctLevel=t.correctLevel||a.L,this.options=t;var e=new n(t.typeNumber||-1,t.correctLevel);e.addData(t.text),e.make();var i=t.drawer||"canvas";switch(i){case"canvas":return this.makeCanvas(e,t);case"svg":return this.makeSVG(e,t);case"table":return this.makeTable(e,t)}}var n,a,s,l,d,h,g,c,u,f,p,v,w,m,y,C,_,b,E,A;r.prototype.getByte=function(r,t){for(var e=[],i=0;i<8;i++)e.push(t.get(r*t.width+i));for(var o=0,n=0;n<8;n++)o+=e[n]<<7-n;return o},r.prototype.getLength=function(){return this.data.length},r.prototype.getBits=function(r){return(255&this.data[Math.floor(r/8)])>>7-r%8&1},r.prototype.write=function(r){for(var t=0,e=this.data.length;t<e;t++)for(var i=0;i<8;i++)r.set(t*r.width+i,this.getBits(8*t+i))},t.prototype={getErrorsCorrectCapacity:function(r){switch(r){case a.L:return 1;case a.M:return 0;case a.Q:return 3;case a.H:return 2}},getRSBlocks:function(r,t){var e=this.getErrorsCorrectCapacity(t);return s[r][e]},addData:function(t){var e=new r(t);this.dataList.push(e),this.dataCache=null},isDark:function(r,t){if(r<0||this.moduleCount<=r||t<0||this.moduleCount<=t)throw new Error(r+","+t);return this.modules[r][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(r,e){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var o=0;o<this.moduleCount;o++){this.modules[o]=new Array(this.moduleCount);for(var n=0;n<this.moduleCount;n++)this.modules[o][n]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(r,e),this.typeNumber>=7&&this.setupTypeNumber(r),null==this.dataCache&&(this.dataCache=t.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,e)},setupPositionProbePattern:function(r,t){for(var e=-1;e<=7;e++)if(!(r+e<=-1||this.moduleCount<=r+e))for(var i=-1;i<=7;i++)t+i<=-1||this.moduleCount<=t+i||(e>=0&&e<=6&&(0==i||6==i)||i>=0&&i<=6&&(0==e||6==e)||e>=2&&e<=4&&i>=2&&i<=4?this.modules[r+e][t+i]=!0:this.modules[r+e][t+i]=!1)},getBestMaskPattern:function(){for(var r=0,t=0,e=0;e<8;e++){this.makeImpl(!0,e);var i=l.getLostPoint(this);(0==e||r>i)&&(r=i,t=e)}return t},createMovieClip:function(r,t,e){var i=r.createElement("div");i.style.width=this.getModuleCount()*e+"px",i.style.height=this.getModuleCount()*e+"px";for(var o=0;o<this.getModuleCount();o++)for(var n=0;n<this.getModuleCount();n++){var a=r.createElement("div");a.style.width=e+"px",a.style.height=e+"px",a.style.position="absolute",a.style.left=n*e+"px",a.style.top=o*e+"px",a.style.backgroundColor=this.isDark(o,n)?"#000000":"#ffffff",i.appendChild(a)}return i},setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++)null==this.modules[r][6]&&(this.modules[r][6]=r%2==0);for(var t=8;t<this.moduleCount-8;t++)null==this.modules[6][t]&&(this.modules[6][t]=t%2==0)},setupPositionAdjustPattern:function(){for(var r=d.getPattern(this.typeNumber),t=0;t<r.length;t++)for(var e=0;e<r.length;e++){var i=r[t],o=r[e];if(null==this.modules[i][o])for(var n=-2;n<=2;n++)for(var a=-2;a<=2;a++)-2==n||2==n||-2==a||2==a||0==n&&0==a?this.modules[i+n][o+a]=!0:this.modules[i+n][o+a]=!1}},setupTypeNumber:function(r){for(var t=l.getBCHTypeNumber(this.typeNumber),e=0;e<18;e++){var i=!r&&1==(t>>e&1);this.modules[Math.floor(e/3)][e%3+this.moduleCount-8-3]=i}for(e=0;e<18;e++){i=!r&&1==(t>>e&1);this.modules[e%3+this.moduleCount-8-3][Math.floor(e/3)]=i}},setupTypeInfo:function(r,t){for(var e=this.errorCorrectLevel<<3|t,i=l.getBCHTypeInfo(e),o=0;o<15;o++){var n=!r&&1==(i>>o&1);o<6?this.modules[o][8]=n:o<8?this.modules[o+1][8]=n:this.modules[this.moduleCount-15+o][8]=n}for(o=0;o<15;o++){n=!r&&1==(i>>o&1);o<8?this.modules[8][this.moduleCount-o-1]=n:o<9?this.modules[8][15-o-1+1]=n:this.modules[8][15-o-1]=n}this.modules[this.moduleCount-8][8]=!r},mapData:function(r,t){for(var e=-1,i=this.moduleCount-1,o=7,n=0,a=this.moduleCount-1;a>0;a-=2)for(6==a&&a--;;){for(var s=0;s<2;s++)if(null==this.modules[i][a-s]){var d=!1;n<r.length&&(d=1==(r[n]>>>o&1));h.getMask(t,i,a-s)&&(d=!d),this.modules[i][a-s]=d,o--,-1==o&&(n++,o=7)}if((i+=e)<0||this.moduleCount<=i){i-=e,e=-e;break}}}},t.PAD0=236,t.PAD1=17,t.createData=function(r,e,o){for(var n=t.getRSBlocks(r,e),a=new i,s=0;s<o.length;s++){var l=o[s];a.dataCount+=l.getLength(),a.totalCount+=l.getLength()}for(var d=0,h=0;h<n.length;h++)d+=n[h].dataCount;if(a.totalCount>d)throw new Error("code length overflow. ("+a.totalCount+">"+d+")");for(a.totalCount+=(d-a.totalCount+3-a.totalCount%4)%4,s=0;s<o.length;s++)a.put(o[s].data);if(a.totalCount<d)for(s=0;s<d-a.totalCount;s++)a.put(t.PAD0),s%2==1&&a.put(t.PAD1);var g=new Array(n.length),c=new Array(n.length),u=0;for(s=0;s<n.length;s++){var f=n[s].dataCount,p=n[s].totalCount-f;u=Math.max(u,f);for(var v=0;v<f;v++)g[s]=a.buffer[v];c[s]=t.createBytes(p);for(v=0;v<n[s].rsBlock.length;v++){var w=n[s].rsBlock[v];g[s][f-w.dataCount-1]=w.buffer[w.dataCount-1]}}for(var m=new Array(u),s=0;s<u;s++)for(v=0;v<n.length;v++)s<g[v].length&&(m[s]=g[v][s]);var y=new Array(u);for(s=0;s<u;s++){for(var C=new Array(1),v=0;v<m.length;v++)C.push(m[v][s]);for(var _=t.getPolynomial(C),b=t.getGeneratorPolynomial(_),E=_.getAt(_.getLength()-1),A=0;A<b.getLength();A++)y[s][A]=b.getAt(b.getLength()-A-1)^E.getAt(E.getLength()-A-1)}var M=new Array(a.totalCount),B=0;for(s=0;s<n.length;s++)for(v=0;v<n[s].totalCount;v++)v<n[s].dataCount?M[B++]=g[s][v]:M[B++]=c[s][v-n[s].dataCount];return M},t.createBytes=function(r){for(var t=new Array(r),e=0;e<r;e++)t[e]=0;return t},t.getPolynomial=function(r){for(var t=new e(r,0),i=new e([1],t.getLength()-1),o=0;t.getLength()>0;){var n=t.getAt(0);if(0!=n){for(var a=l.log(n),s=0;s<i.getLength();s++)i.setAt(s,i.getAt(s)^l.exp(a+i.getAt(s)));t=t.shift(i)}}return i},t.getGeneratorPolynomial=function(r){for(var t=new e([1],0),i=0;i<r;i++)t=t.multiply(new e([1,l.exp(i)],0));return t},a={L:1,M:0,Q:3,H:2},s=[[],[[1,26,19],[1,26,16],[1,26,13],[1,26,9]],[[1,44,34],[1,44,28],[1,44,22],[1,44,16]],[[1,70,55],[1,70,44],[1,70,34],[1,70,26]],[[1,100,80],[1,100,64],[1,100,48],[1,100,36]],[[1,134,108],[1,134,86],[2,67,43],[2,67,31]],[[2,86,68],[2,86,54],[2,86,38],[2,86,28]],[[2,98,78],[2,98,62],[2,98,46],[2,98,34]],[[2,121,97],[2,121,77],[2,121,55],[4,121,39]],[[2,146,116],[3,146,92],[4,146,68],[4,146,48]],[[2,87,68,2,88,69],[4,87,54,1,88,55],[6,87,38,2,88,39],[6,87,28,2,88,29]],[[4,101,81],[1,101,80,4,102,81],[4,101,50,4,102,51],[4,101,36,4,102,37]],[[2,116,92,2,117,93],[6,116,73,2,117,74],[4,116,54,6,117,55],[7,116,45,4,117,46]],[[4,110,87,5,111,88],[5,110,65,5,111,66],[5,110,41,5,111,42],[5,110,33,5,111,34]],[[5,122,98,1,123,99],[7,122,78,3,123,79],[15,122,43],[3,122,35,13,123,36]],[[1,135,107,5,136,108],[10,135,81,1,136,82],[1,135,50,15,136,51],[2,135,40,17,136,41]],[[5,140,115,1,141,116],[9,140,74,5,141,75],[17,140,44],[17,140,34,1,141,35]],[[9,151,119,4,152,120],[3,151,75,13,152,76],[15,151,48,5,152,49],[15,151,43,5,152,44]],[[13,163,132,2,164,133],[17,163,82],[7,163,54,17,164,55],[3,163,44,19,164,45]],[[17,177,145],[10,177,91,10,178,92],[19,177,61,1,178,62],[19,177,46,3,178,47]],[[7,175,140,12,176,141],[17,175,87,4,176,88],[29,175,59],[11,175,44,14,176,45]],[[13,186,152,8,187,153],[13,186,86,10,187,87],[11,186,64,16,187,65],[11,186,48,16,187,49]],[[17,196,158,4,197,159],[17,196,98,6,197,99],[7,196,73,17,11,197,74],[7,196,55,21,197,56]],[[4,209,170,18,210,171],[13,209,107,10,210,108],[19,209,78,8,210,79],[15,209,60,13,210,61]],[[3,224,180,18,225,181],[3,224,113,19,225,114],[11,224,84,19,225,85],[11,224,65,22,225,66]],[[13,235,187,12,236,188],[13,235,115,12,236,116],[2,235,87,29,236,88],[4,235,68,28,236,69]],[[15,250,203,4,251,204],[4,250,127,18,251,128],[29,250,97,1,251,98],[23,250,75,6,251,76]],g=new Array(256),c=new Array(256);for(u=0;u<8;u++)g[u]=1<<u;for(u=8;u<256;u++)g[u]=g[u-4]^g[u-5]^g[u-6]^g[u-8];for(u=0;u<255;u++)c[g[u]]=u;l={glog:function(r){if(r<1)throw new Error("glog("+r+")");return c[r]},gexp:function(r){for(;r<0;)r+=255;for(;r>=256;)r-=255;return g[r]},getBCHTypeInfo:function(r){for(var t=r<<10;this.getBCHDigit(t)-this.getBCHDigit(r<<5)>=0;);return(r<<10|t)^21522},getBCHTypeNumber:function(r){for(var t=r<<12;this.getBCHDigit(t)-this.getBCHDigit(r<<7)>=0;);return(r<<12|t)^30176},getBCHDigit:function(r){for(var t=0;r>>t+1!=0;)t++;return t},getPattern:function(r){return d[r-1]},getMask:function(r,t,e){switch(r){case 0:return(t+e)%2==0;case 1:return t%2==0;case 2:return e%3==0;case 3:return(t+e)%3==0;case 4:return(Math.floor(t/2)+Math.floor(e/3))%2==0;case 5:return t*e%2+t*e%3==0;case 6:return(t*e%2+t*e%3)%2==0;case 7:return(t*e%3+(t+e)%2)%2==0;default:throw new Error("bad maskPattern:"+r)}},d=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],o.prototype.makeCanvas=function(r,t){t=t||{};var e=document.createElement("canvas"),i=t.size||t.width||t.height||100;t.size=t.width=t.height=i;for(var o=e.getContext("2d"),n=r.getModuleCount(),a=i/n,s=0;s<n;s++)for(var l=0;l<n;l++){o.fillStyle=r.isDark(s,l)?t.colorDark:t.colorLight;var d=Math.ceil((l+1)*a)-Math.floor(l*a),h=Math.ceil((s+1)*a)-Math.floor(s*a);o.fillRect(Math.round(l*a),Math.round(s*a),d,h)}return e},o.prototype.makeTable=function(r,t){t=t||{};var e=[],i=r.getModuleCount();e.push('<table style="border:0;border-collapse:collapse;">');for(var o=0;o<i;o++){e.push("<tr>");for(var n=0;n<i;n++)e.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:1px;height:1px;background-color:'+(r.isDark(o,n)?t.colorDark:t.colorLight)+';"></td>');e.push("</tr>")}return e.push("</table>"),e.join("")},o.prototype.makeSVG=function(r,t){t=t||{};var e=r.getModuleCount(),i=t.size||t.width||t.height,o=t.margin||0,n=i/e,a="",s=function(r,e,i,o){var n={};for(var a in r)n[a]=r[a];for(var a in o)n[a]=o[a];return'<rect x="'+e*n.width+'" y="'+r*n.width+'" width="'+n.width+'" height="'+n.width+'"'+(n.title?' title="'+n.title+'"':"")+' style="fill:'+n.color+'" />'};return a+='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="'+i+'px" height="'+i+'px" viewBox="0 0 '+i+" "+i+'">',a+='<rect width="'+i+'" height="'+i+'" style="fill:'+t.colorLight+'" />',a+='<g style="fill:'+t.colorDark+'">',a+="</g>",a+="</svg>"},"object"==typeof module&&module.exports?module.exports=o:"function"==typeof define&&define.amd?define([],function(){return o}):window.QRCode=o,QRCode=o}();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            const state = {
                countries: [],
                cities: [],
                selectedCountry: null,
                selectedCity: null,
                decodedInfo: null,
                isLoading: false,
                currentView: 'countries', // 'countries' or 'cities'
            };

            // --- API CONFIGURATION ---
            const API_BASE_URL = 'https://number.messagersr.workers.dev';
            const API_HEADERS = {
                "Host": "number.messagersr.workers.dev",
                "x-web-app-token": "258k5cxvaij7gxjmtbtd1e2gmwcy10weauk8zebg930pedrd8mda3icjub0p0lnn",
                "Accept-Language": "en-US,en;q=0.9",
                "Accept": "application/json, text/plain, */*",
                "Origin": "https://web.dvpnbot.com",
                "Referer": "https://web.dvpnbot.com/",
                "Content-Type": "application/json"
            };

            // --- DOM ELEMENTS ---
            const initialView = document.getElementById('initial-view');
            const credentialsView = document.getElementById('credentials-view');
            const selectLocationBtn = document.getElementById('select-location-btn');
            const resetBtn = document.getElementById('reset-btn');
            const showQrBtn = document.getElementById('show-qr-btn');
            const locationModal = document.getElementById('location-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalLoader = document.getElementById('modal-loader');
            const locationList = document.getElementById('location-list');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalBackBtn = document.getElementById('modal-back-btn');
            const qrModal = document.getElementById('qr-modal');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const qrCloseBtn = document.getElementById('qr-close-btn');
            const errorBox = document.getElementById('error-box');
            const toast = document.getElementById('toast');
            
            // --- UI UPDATE FUNCTIONS ---

            const setLoading = (loading) => {
                state.isLoading = loading;
                modalLoader.style.display = loading ? 'block' : 'none';
                if (!loading) {
                    locationList.style.display = 'block';
                } else {
                    locationList.style.display = 'none';
                }
            };
            
            const showError = (message) => {
                errorBox.textContent = message;
                errorBox.style.display = 'block';
                setTimeout(() => {
                    errorBox.style.display = 'none';
                }, 5000);
            }
            
            const showToast = (message) => {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }
            
            const updateMainView = () => {
                if (state.decodedInfo) {
                    initialView.style.display = 'none';
                    credentialsView.style.display = 'flex';
                    
                    document.getElementById('selected-location').textContent = `${state.selectedCity.name}, ${state.selectedCountry.name}`;
                    document.getElementById('ip-value').textContent = state.decodedInfo.ip;
                    document.getElementById('port-value').textContent = state.decodedInfo.port;
                    document.getElementById('protocol-value').textContent = state.decodedInfo.protocolName.toUpperCase();
                    
                    const vmessLinkOutput = document.getElementById('vmess-link-output');
                    vmessLinkOutput.textContent = state.decodedInfo.vmessURL;
                    vmessLinkOutput.onclick = () => copyToClipboard(state.decodedInfo.vmessURL);

                    selectLocationBtn.style.display = 'none';
                } else {
                    initialView.style.display = 'block';
                    credentialsView.style.display = 'none';
                    selectLocationBtn.style.display = 'block';
                }
            };

            const renderLocationList = () => {
                locationList.innerHTML = '';
                const items = state.currentView === 'countries' ? state.countries : state.cities;
                
                if (items.length === 0 && !state.isLoading) {
                    locationList.innerHTML = `<li>No ${state.currentView} available.</li>`;
                    return;
                }
                
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.dataset.id = item.id;
                    li.innerHTML = `
                        <span>${item.name}</span>
                        <span class="servers-count">${item.servers_available} servers</span>
                    `;
                    li.addEventListener('click', () => handleLocationClick(item));
                    locationList.appendChild(li);
                });
            };

            // --- DATA PROCESSING & API LOGIC ---

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Copied to Clipboard!');
                }, (err) => {
                    showError('Failed to copy.');
                    console.error('Clipboard copy failed:', err);
                });
            }
            
            // Converts a base64 string to a Uint8Array.
            function base64ToBytes(base64) {
                const binString = atob(base64);
                return Uint8Array.from(binString, m => m.charCodeAt(0));
            }

            function decodeV2rayPayload(payloadB64, uid) {
                try {
                    const data = base64ToBytes(payloadB64);
                    if (data.length < 7) return null;
                    
                    const dataView = new DataView(data.buffer);

                    const ip = `${data[0]}.${data[1]}.${data[2]}.${data[3]}`;
                    const port = dataView.getUint16(4, false); // big-endian
                    const protoByte = data[6];
                    const protoMap = {
                        0x01: "tcp", 0x02: "mkcp", 0x03: "websocket",
                        0x04: "http", 0x05: "domainsocket", 0x06: "quic",
                        0x07: "gun", 0x08: "grpc"
                    };
                    const protocolName = protoMap[protoByte] || `unknown (0x${protoByte.toString(16)})`;

                    const vmessConfig = {
                        "v": "2", "ps": "dVPNBot-Web", "add": ip, "port": port.toString(),
                        "id": uid, "aid": "0", "net": protocolName, "type": "none",
                        "host": "", "path": "", "tls": "none"
                    };
                    
                    const vmessJsonString = JSON.stringify(vmessConfig);
                    let base64 = btoa(vmessJsonString).replace(/=+$/, ''); // Encode and remove padding

                    const vmessURL = `vmess://${base64}`;

                    return { ip, port, protocolName, vmessURL };
                } catch (e) {
                    console.error("Failed to decode payload:", e);
                    return null;
                }
            }

            const apiFetch = async (endpoint, options = {}) => {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        headers: API_HEADERS,
                        ...options,
                    });
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    const json = await response.json();
                    return json.data;
                } catch (error) {
                    console.error(`Fetch error for ${endpoint}:`, error);
                    showError(error.message);
                    throw error;
                }
            };
            
            const fetchCountries = async () => {
                if (state.countries.length > 0) return;
                setLoading(true);
                try {
                    state.countries = await apiFetch('/country');
                } finally {
                    setLoading(false);
                    renderLocationList();
                }
            };
            
            const fetchCities = async (countryId) => {
                setLoading(true);
                try {
                    state.cities = await apiFetch(`/country/${countryId}/city`);
                } finally {
                    setLoading(false);
                    renderLocationList();
                }
            };
            
            const fetchCredentials = async (cityId) => {
                locationModal.classList.remove('active');
                showToast('Fetching credentials...');
                try {
                    const credentials = await apiFetch(`/city/${cityId}/credentials`, {
                        method: 'POST',
                        body: '{}',
                    });
                    const decoded = decodeV2rayPayload(credentials.payload, credentials.uid);
                    if (decoded) {
                        state.decodedInfo = decoded;
                        updateMainView();
                    } else {
                        showError("Failed to decode server credentials.");
                    }
                } catch (error) {
                    // showError is called inside apiFetch
                }
            };

            // --- EVENT HANDLERS ---
            
            const handleLocationClick = (item) => {
                if (state.currentView === 'countries') {
                    state.selectedCountry = item;
                    state.currentView = 'cities';
                    modalTitle.textContent = `Select City in ${item.name}`;
                    modalBackBtn.style.display = 'block';
                    fetchCities(item.id);
                } else {
                    state.selectedCity = item;
                    fetchCredentials(item.id);
                }
            };

            selectLocationBtn.addEventListener('click', () => {
                state.currentView = 'countries';
                modalTitle.textContent = 'Select Country';
                modalBackBtn.style.display = 'none';
                locationModal.classList.add('active');
                fetchCountries().then(renderLocationList);
            });
            
            resetBtn.addEventListener('click', () => {
                state.decodedInfo = null;
                state.selectedCity = null;
                state.selectedCountry = null;
                updateMainView();
            });

            modalCloseBtn.addEventListener('click', () => locationModal.classList.remove('active'));
            
            modalBackBtn.addEventListener('click', () => {
                state.currentView = 'countries';
                modalTitle.textContent = 'Select Country';
                modalBackBtn.style.display = 'none';
                state.cities = [];
                renderLocationList();
            });
            
            showQrBtn.addEventListener('click', () => {
                if (!state.decodedInfo) return;
                qrCodeContainer.innerHTML = ''; // Clear previous QR
                new QRCode(qrCodeContainer, {
                    text: state.decodedInfo.vmessURL,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                qrModal.classList.add('active');
            });
            
            qrCloseBtn.addEventListener('click', () => qrModal.classList.remove('active'));

        });
    </script>
</body>
</html>
